generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id             String       @id @default(cuid())
  type           ActivityType
  title          String
  description    String?
  leadId         String?
  campaignId     String?
  userId         String?
  metadata       Json?
  createdAt      DateTime     @default(now())
  organizationId String
  campaign       Campaign?    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead           Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([createdAt])
  @@index([leadId])
  @@index([type])
  @@index([userId])
  @@index([organizationId, createdAt])
  @@index([organizationId])
}

model APIKeyAudit {
  id        String   @id @default(cuid())
  userId    String
  provider  String
  action    String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([provider])
}

model Appointment {
  id             String            @id @default(cuid())
  title          String
  description    String?
  startTime      DateTime
  endTime        DateTime
  location       String?
  meetingUrl     String?
  type           AppointmentType
  status         AppointmentStatus @default(SCHEDULED)
  userId         String
  leadId         String?
  attendees      Json?
  reminderSent   Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organizationId String
  lead           Lead?             @relation(fields: [leadId], references: [id], onDelete: SetNull)
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([startTime])
  @@index([status])
  @@index([type])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, startTime])
}

model CustomFieldDefinition {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  fieldKey       String
  type           String   // text, number, date, dropdown, boolean, textarea
  required       Boolean  @default(false)
  options        Json?    // string[] for dropdown options
  order          Int      @default(0)
  defaultValue   String?
  placeholder    String?
  validation     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, fieldKey])
  @@index([organizationId])
}

model BusinessSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  companyName   String?
  address       String?
  phone         String?
  website       String?
  logo          String?
  billingEmail  String?
  businessHours Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Campaign {
  id               String         @id @default(cuid())
  name             String
  type             CampaignType
  status           CampaignStatus @default(DRAFT)
  subject          String?
  body             String?
  previewText      String?
  startDate        DateTime?
  endDate          DateTime?
  budget           Float?
  spent            Float?         @default(0)
  audience         Int?
  sent             Int            @default(0)
  delivered        Int            @default(0)
  opened           Int            @default(0)
  clicked          Int            @default(0)
  converted        Int            @default(0)
  bounced          Int            @default(0)
  unsubscribed     Int            @default(0)
  revenue          Float?         @default(0)
  roi              Float?
  isABTest         Boolean        @default(false)
  abTestData       Json?
  createdById      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  frequency        String?
  isRecurring      Boolean        @default(false)
  lastSentAt       DateTime?
  maxOccurrences   Int?
  nextSendAt       DateTime?
  occurrenceCount  Int            @default(0)
  recurringPattern Json?
  archivedAt       DateTime?
  isArchived       Boolean        @default(false)
  organizationId   String
  ABTestResult     ABTestResult[]
  activities       Activity[]
  campaignLeads    CampaignLead[]
  campaignAnalytics CampaignAnalytics?
  user             User?          @relation(fields: [createdById], references: [id], onDelete: SetNull)
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tags             Tag[]          @relation("CampaignToTag")

  @@index([createdAt])
  @@index([createdById])
  @@index([status])
  @@index([type])
  @@index([startDate])
  @@index([createdById, status])
  @@index([status, startDate])
  @@index([nextSendAt])
  @@index([isRecurring, nextSendAt])
  @@index([organizationId])
  @@index([organizationId, status])
}

model EmailConfig {
  id           String   @id @default(cuid())
  userId       String   @unique
  provider     String   @default("sendgrid")
  apiKey       String?
  fromEmail    String?
  fromName     String?
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPassword String?
  isActive     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id             String       @id @default(cuid())
  name           String
  subject        String
  body           String
  category       String?
  isActive       Boolean      @default(true)
  variables      Json?
  usageCount     Int          @default(0)
  lastUsedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isActive])
  @@index([organizationId, category])
  @@index([organizationId])
}

model Integration {
  id          String    @id @default(cuid())
  userId      String
  provider    String
  isConnected Boolean   @default(false)
  credentials Json?
  config      Json?
  lastSyncAt  DateTime?
  syncStatus  String?
  syncError   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([provider])
  @@index([userId])
}

model Lead {
  id                String         @id @default(cuid())
  email             String
  phone             String?
  company           String?
  position          String?
  status            LeadStatus     @default(NEW)
  score             Int            @default(0)
  source            String?
  value             Float?
  stage             String?
  assignedToId      String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastContactAt     DateTime?
  customFields      Json?
  firstName         String
  lastName          String
  emailOptIn        Boolean        @default(true)
  emailOptOutAt     DateTime?
  emailOptOutReason String?
  unsubscribeToken  String?        @unique
  organizationId    String
  scoreUpdatedAt    DateTime?
  expectedCloseDate DateTime?
  ABTestResult      ABTestResult[]
  activities        Activity[]
  appointments      Appointment[]
  Call              Call[]
  campaignLeads     CampaignLead[]
  assignedTo        User?          @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages          Message[]
  notes             Note[]
  tasks             Task[]
  tags              Tag[]          @relation("LeadToTag")

  @@unique([organizationId, email])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([score])
  @@index([source])
  @@index([status])
  @@index([status, score])
  @@index([assignedToId, status])
  @@index([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, status])
}

model Message {
  id              String           @id @default(cuid())
  type            MessageType
  direction       MessageDirection
  subject         String?
  body            String
  fromAddress     String
  toAddress       String
  status          MessageStatus    @default(PENDING)
  readAt          DateTime?
  repliedAt       DateTime?
  leadId          String?
  threadId        String?
  parentId        String?
  externalId      String?
  provider        String?
  metadata        Json?
  createdAt       DateTime         @default(now())
  sentAt          DateTime?
  bounceReason    String?
  bounceType      String?
  bouncedAt       DateTime?
  deliveredAt     DateTime?
  lastRetryAt     DateTime?
  maxRetries      Int              @default(3)
  retryCount      Int              @default(0)
  spamComplaintAt DateTime?
  starred         Boolean          @default(false)
  archived        Boolean          @default(false)
  snoozedUntil    DateTime?
  organizationId  String
  lead            Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([direction])
  @@index([leadId])
  @@index([status])
  @@index([threadId])
  @@index([type])
  @@index([sentAt])
  @@index([leadId, status])
  @@index([type, sentAt])
  @@index([bouncedAt])
  @@index([bounceType])
  @@index([spamComplaintAt])
  @@index([organizationId])
}

model Note {
  id        String   @id @default(cuid())
  content   String
  leadId    String
  authorId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User?    @relation("NoteAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([leadId])
}

model NotificationSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  channels           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SMSConfig {
  id          String   @id @default(cuid())
  userId      String   @unique
  provider    String   @default("twilio")
  accountSid  String?
  authToken   String?
  phoneNumber String?
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SMSTemplate {
  id             String       @id @default(cuid())
  name           String
  body           String
  category       String?
  isActive       Boolean      @default(true)
  variables      Json?
  usageCount     Int          @default(0)
  lastUsedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isActive])
  @@index([organizationId, category])
  @@index([organizationId])
}

model Tag {
  id             String       @id @default(cuid())
  name           String
  color          String?
  createdAt      DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaigns      Campaign[]   @relation("CampaignToTag")
  leads          Lead[]       @relation("LeadToTag")

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Task {
  id             String       @id @default(cuid())
  title          String
  description    String?
  status         TaskStatus   @default(PENDING)
  priority       TaskPriority @default(MEDIUM)
  dueDate        DateTime?
  leadId         String?
  lead           Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  assignedToId   String?
  assignedTo     User?        @relation("TaskAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  completedAt    DateTime?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([leadId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([priority])
  @@index([status])
}

model Team {
  id               String           @id @default(cuid())
  name             String
  slug             String           @unique
  settings         Json?
  // Cached from Subscription.tier — kept in sync by subscription update logic
  subscriptionTier SubscriptionTier @default(FREE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  teamMembers      TeamMember[]

  @@index([slug])
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model User {
  id                   String                @id @default(cuid())
  email                String
  password             String
  firstName            String
  lastName             String
  avatar               String?
  phone                String?
  jobTitle             String?
  company              String?
  address              String?
  role                 Role                  @default(USER)
  isActive             Boolean               @default(true)
  emailVerified        Boolean               @default(false)
  timezone             String                @default("America/New_York")
  language             String                @default("en")
  lastLoginAt          DateTime?
  lastLoginIp          String?
  twoFactorEnabled     Boolean               @default(false)
  twoFactorSecret      String?
  // Cached from Subscription.tier — kept in sync by subscription update logic
  subscriptionTier     SubscriptionTier      @default(FREE)
  subscriptionId       String?
  trialEndsAt          DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organizationId       String
  ABTest               ABTest[]
  aPIKeyAudit          APIKeyAudit[]
  activities           Activity[]
  appointments         Appointment[]
  businessSettings     BusinessSettings?
  campaigns            Campaign[]
  ChatMessage          ChatMessage[]
  emailConfig          EmailConfig?
  integrations         Integration[]
  leads                Lead[]                @relation("LeadAssignedTo")
  LeadScoringModel     LeadScoringModel?
  notes                Note[]                @relation("NoteAuthor")
  Notification         Notification[]
  notificationSettings NotificationSettings?
  ScoringConfigUpdates ScoringConfig[]       @relation("ScoringConfigUpdatedBy")
  savedReports         SavedReport[]
  smsConfig            SMSConfig?
  tasks                Task[]                @relation("TaskAssignedTo")
  teamMembers          TeamMember[]
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  UserAIPreferences    UserAIPreferences?
  refreshTokens        RefreshToken[]
  passwordResetTokens  PasswordResetToken[]
  loginHistory         LoginHistory[]
  ModelPerformanceHistory ModelPerformanceHistory[]

  @@unique([organizationId, email])
  @@index([email])
  @@index([role])
  @@index([organizationId])
}

model Workflow {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  isActive           Boolean             @default(false)
  triggerType        WorkflowTrigger
  triggerData        Json?
  actions            Json
  executions         Int                 @default(0)
  successRate        Float?
  lastRunAt          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organizationId     String
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflowExecutions WorkflowExecution[]

  @@index([isActive])
  @@index([triggerType])
  @@index([organizationId])
  @@index([organizationId, isActive])
}

model Segment {
  id             String       @id @default(cuid())
  name           String
  description    String?
  rules          Json         // Array of { field, operator, value } filter rules
  matchType      String       @default("all") // "all" = AND, "any" = OR
  memberCount    Int          @default(0)
  isActive       Boolean      @default(true)
  color          String?      @default("#3B82F6")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
}

model WorkflowExecution {
  id          String          @id @default(cuid())
  workflowId  String
  status      ExecutionStatus
  error       String?
  leadId      String?
  metadata    Json?
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  workflow    Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([startedAt])
  @@index([status])
  @@index([workflowId])
}

model ABTest {
  id               String         @id @default(cuid())
  name             String
  description      String?
  type             ABTestType
  organizationId   String
  createdBy        String?
  variantA         Json
  variantB         Json
  status           ABTestStatus   @default(DRAFT)
  startDate        DateTime?
  endDate          DateTime?
  participantCount Int            @default(0)
  winnerId         String?
  confidence       Float?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  creator          User?          @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  results          ABTestResult[]

  @@index([createdBy])
  @@index([organizationId])
  @@index([startDate])
  @@index([status])
}

model ABTestResult {
  id         String    @id @default(cuid())
  testId     String
  variant    String
  leadId     String?
  campaignId String?
  converted  Boolean   @default(false)
  openedAt   DateTime?
  clickedAt  DateTime?
  repliedAt  DateTime?
  metadata   Json?
  createdAt  DateTime  @default(now())
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  lead       Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  abtest     ABTest    @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([converted])
  @@index([leadId])
  @@index([testId])
  @@index([variant])
}

model AIAssistant {
  id              String       @id @default(cuid())
  organizationId  String
  vapiAssistantId String
  name            String
  businessName    String
  greeting        String
  voice           String
  knowledgeBase   Json
  phoneNumber     String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Call            Call[]

  @@index([organizationId])
  @@index([organizationId, isActive])
}

model Call {
  id                String       @id @default(cuid())
  organizationId    String
  leadId            String?
  assistantId       String?
  vapiCallId        String       @unique
  direction         String
  phoneNumber       String
  status            String
  duration          Int?
  cost              Float?
  transcript        String?
  recording         String?
  sentiment         String?
  appointmentBooked Boolean      @default(false)
  metadata          Json?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  aiassistant       AIAssistant? @relation(fields: [assistantId], references: [id], onDelete: SetNull)
  lead              Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([direction])
  @@index([leadId])
  @@index([organizationId, createdAt])
  @@index([status])
}

model ChatMessage {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String
  content        String
  tokens         Int?
  cost           Float?
  metadata       Json?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId])
  @@index([userId, createdAt])
}

model Invoice {
  id              String        @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String?       @unique
  amount          Float
  currency        String        @default("usd")
  status          InvoiceStatus
  invoiceDate     DateTime
  dueDate         DateTime
  paidAt          DateTime?
  pdfUrl          String?
  createdAt       DateTime      @default(now())
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([subscriptionId])
}

model LeadScoringModel {
  id                String       @id @default(cuid())
  factors           Json
  accuracy          Float?
  lastTrainedAt     DateTime?
  trainingDataCount Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  userId            String       @unique
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model ScoringConfig {
  id               String       @id @default(cuid())
  organizationId   String       @unique
  weights          Json         // { engagement: 30, demographic: 25, behavior: 25, timing: 20 }
  emailOpenWeight      Float    @default(5)
  emailClickWeight     Float    @default(10)
  emailReplyWeight     Float    @default(15)
  formSubmissionWeight Float    @default(20)
  propertyInquiryWeight Float   @default(25)
  scheduledApptWeight  Float    @default(30)
  completedApptWeight  Float    @default(40)
  emailOptOutPenalty   Float    @default(-50)
  recencyBonusMax      Float    @default(20)
  frequencyBonusMax    Float    @default(15)
  updatedAt        DateTime     @updatedAt
  updatedById      String?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  updatedBy        User?        @relation("ScoringConfigUpdatedBy", fields: [updatedById], references: [id])
}

model Notification {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  type           String
  title          String
  message        String
  link           String?
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([organizationId])
  @@index([read])
  @@index([userId])
}

model Organization {
  id                String              @id @default(cuid())
  name              String
  slug              String              @unique
  domain            String?             @unique
  logo              String?
  // Cached from Subscription.tier — kept in sync by subscription update logic
  subscriptionTier  SubscriptionTier    @default(FREE)
  subscriptionId    String?
  trialEndsAt       DateTime?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  // Phase 3: Org-level AI configuration
  openaiApiKey          String?         // Encrypted at rest
  openaiOrgId           String?
  useOwnAIKey           Boolean         @default(false)
  aiSystemPrompt        String?         // Custom instructions for org AI
  aiDefaultTone         String          @default("professional")
  aiDefaultModel        String?         // Override default model
  aiMaxTokensPerRequest Int?            // Override max tokens
  aiMonthlyTokenBudget  Int?            // Optional hard cap
  ABTest            ABTest[]
  AIAssistant       AIAssistant[]
  AIInsight         AIInsight[]
  Activity          Activity[]
  Appointment       Appointment[]
  Call              Call[]
  Campaign          Campaign[]
  ChatMessage       ChatMessage[]
  CustomFieldDefinition CustomFieldDefinition[]
  EmailTemplate     EmailTemplate[]
  Lead              Lead[]
  LeadScoringModel  LeadScoringModel[]
  Message           Message[]
  ModelPerformanceHistory ModelPerformanceHistory[]
  Notification      Notification[]
  ScoringConfig     ScoringConfig?
  Segment           Segment[]
  SMSTemplate       SMSTemplate[]
  Subscription      Subscription?
  Tag               Tag[]
  Task              Task[]
  users             User[]
  UserAIPreferences UserAIPreferences[]
  SavedReport       SavedReport[]
  Workflow          Workflow[]
  EmailSuppression  EmailSuppression[]
  CampaignLead      CampaignLead[]
  CampaignAnalytics CampaignAnalytics[]
  LoginHistory      LoginHistory[]

  @@index([isActive])
  @@index([slug])
}

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  tier                 SubscriptionTier
  status               SubscriptionStatus
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  trialEndsAt          DateTime?
  cancelAt             DateTime?
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  Invoice              Invoice[]
  organization         Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  UsageTracking        UsageTracking[]
}

model UsageTracking {
  id                    String       @id @default(cuid())
  subscriptionId        String
  month                 String       // YYYY-MM format
  aiMessages            Int          @default(0)
  contentGenerations    Int          @default(0)
  composeUses           Int          @default(0)
  scoringRecalculations Int          @default(0)
  webSearches           Int          @default(0)
  callMinutes           Float        @default(0)
  enhancements          Int          @default(0)
  totalTokensUsed       Int          @default(0)
  totalCost             Float        @default(0)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, month])
  @@index([month])
}

// Phase 1A: Track model performance over time (after each recalibration)
model ModelPerformanceHistory {
  id               String       @id @default(cuid())
  organizationId   String
  userId           String
  modelType        String       @default("lead_scoring") // lead_scoring, engagement, conversion
  accuracyBefore   Float?
  accuracyAfter    Float
  sampleSize       Int
  improvements     Json?        // Array of improvement descriptions
  trainingDuration Int?         // milliseconds
  metadata         Json?        // Extra data (weights, config used, etc.)
  createdAt        DateTime     @default(now())
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([userId])
  @@index([modelType])
}

// Phase 1C: AI-generated insights stored in DB
model AIInsight {
  id             String       @id @default(cuid())
  organizationId String
  type           String       // lead_followup, scoring_accuracy, email_performance, pipeline_health
  priority       String       @default("medium") // low, medium, high, critical
  title          String
  description    String
  data           Json?        // Supporting data (lead IDs, metrics, etc.)
  actionUrl      String?      // Deep link to relevant page
  dismissed      Boolean      @default(false)
  dismissedAt    DateTime?
  dismissedBy    String?
  actedOn        Boolean      @default(false)
  actedOnAt      DateTime?
  actedOnBy      String?
  actionTaken    String?
  expiresAt      DateTime?    // Auto-expire stale insights
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, dismissed])
  @@index([organizationId, type])
  @@index([organizationId, actedOn])
  @@index([priority])
  @@index([expiresAt])
}

model UserAIPreferences {
  id                   String       @id @default(cuid())
  userId               String       @unique
  chatbotTone          String       @default("professional")
  autoSuggestActions   Boolean      @default(true)
  enableProactive      Boolean      @default(true)
  preferredContactTime String?
  aiInsightsFrequency      String       @default("daily")
  insightPriorityThreshold  String       @default("all")
  insightTypes              Json?        @default("[\"lead_followup\",\"scoring_accuracy\",\"email_performance\",\"pipeline_health\"]")
  customInstructions        String?
  // Composer preferences (Phase 4)
  composerDefaultTone          String  @default("professional")
  composerDefaultLength        String  @default("standard")
  composerDefaultCTA           Boolean @default(true)
  composerDefaultPersonalization String @default("standard")
  composerAutoGenerate         Boolean @default(true)
  composerShowAdvanced         Boolean @default(false)
  // AI Profile fields (Phase 2 - AI Hub Rebuild)
  brandGuidelines        String?
  businessContext         String?
  defaultEmailStructure  String    @default("professional")
  propertyDescStyle      String    @default("balanced")
  socialMediaPrefs       Json?
  enhancementLevel       String    @default("moderate")
  // Feature toggles (user-level)
  enableLeadScoring      Boolean   @default(true)
  enableCompose          Boolean   @default(true)
  enableContentGen       Boolean   @default(true)
  enableMessageEnhancer  Boolean   @default(true)
  enableTemplateAI       Boolean   @default(true)
  enableInsights         Boolean   @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organizationId       String
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model SavedReport {
  id               String       @id @default(cuid())
  name             String
  description      String?
  type             String       @default("leads")
  config           Json
  userId           String
  organizationId   String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
}

model RefreshToken {
  id             String    @id @default(cuid())
  token          String    @unique
  userId         String
  organizationId String
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_OPENED
  EMAIL_CLICKED
  SMS_SENT
  SMS_DELIVERED
  CALL_MADE
  CALL_RECEIVED
  MEETING_SCHEDULED
  MEETING_COMPLETED
  NOTE_ADDED
  STATUS_CHANGED
  STAGE_CHANGED
  LEAD_CREATED
  LEAD_ASSIGNED
  CAMPAIGN_LAUNCHED
  CAMPAIGN_COMPLETED
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  CALL
  MEETING
  DEMO
  CONSULTATION
  FOLLOW_UP
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum CampaignType {
  EMAIL
  SMS
  PHONE
  SOCIAL
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

enum MessageType {
  EMAIL
  SMS
  CALL
  SOCIAL
  NEWSLETTER
}

enum Role {
  ADMIN
  MANAGER
  USER
}

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TeamRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

enum WorkflowTrigger {
  LEAD_CREATED
  LEAD_STATUS_CHANGED
  LEAD_ASSIGNED
  CAMPAIGN_COMPLETED
  EMAIL_OPENED
  TIME_BASED
  SCORE_THRESHOLD
  TAG_ADDED
  MANUAL
}

enum ABTestStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum ABTestType {
  EMAIL_SUBJECT
  EMAIL_CONTENT
  EMAIL_TIMING
  SMS_CONTENT
  LANDING_PAGE
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
  INCOMPLETE
}

// Per-lead campaign tracking — records individual lead engagement with campaigns
model CampaignLead {
  id             String    @id @default(cuid())
  campaignId     String
  leadId         String
  organizationId String
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  convertedAt    DateTime?
  bouncedAt      DateTime?
  unsubscribedAt DateTime?
  status         String    @default("PENDING") // PENDING, SENT, DELIVERED, OPENED, CLICKED, BOUNCED, UNSUBSCRIBED
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  campaign       Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead           Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([campaignId, leadId])
  @@index([campaignId])
  @@index([leadId])
  @@index([organizationId])
  @@index([status])
}

// Aggregated campaign analytics — snapshot of campaign performance
model CampaignAnalytics {
  id               String   @id @default(cuid())
  campaignId       String   @unique
  organizationId   String
  totalSent        Int      @default(0)
  totalDelivered   Int      @default(0)
  totalOpened      Int      @default(0)
  totalClicked     Int      @default(0)
  totalConverted   Int      @default(0)
  totalBounced     Int      @default(0)
  totalUnsubscribed Int     @default(0)
  openRate         Float?   @default(0)
  clickRate        Float?   @default(0)
  conversionRate   Float?   @default(0)
  bounceRate       Float?   @default(0)
  revenue          Float?   @default(0)
  lastUpdatedAt    DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  campaign         Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([campaignId])
}

// Login history for session management — tracks user sessions across devices
model LoginHistory {
  id             String    @id @default(cuid())
  userId         String
  organizationId String
  ipAddress      String?
  userAgent      String?
  deviceType     String?
  browser        String?
  os             String?
  country        String?
  city           String?
  isActive       Boolean   @default(true)
  lastActiveAt   DateTime  @default(now())
  loggedOutAt    DateTime?
  createdAt      DateTime  @default(now())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([isActive])
}

// Sprint 9.1 #102: Bounce suppression list — prevents sending to addresses that have bounced or reported spam
model EmailSuppression {
  id             String   @id @default(cuid())
  email          String
  reason         String   // 'bounce', 'spamreport', 'manual'
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}
